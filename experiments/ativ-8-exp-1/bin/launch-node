#!/bin/bash

# Dependencies
# -------------------------------------------------------------------------------------------------
source <(curl -s "https://raw.githubusercontent.com/delucca/shell-functions/1.0.1/modules/feedback.sh")

BIN_DIR_PATH=$(cd -- "$(dirname "$0")" >/dev/null 2>&1 || throw_error "It was not possible to find bin dir" ; pwd -P)
EXPERIMENT_DIR_PATH=$(dirname "${BIN_DIR_PATH}")
ROOT_DIR_PATH=$(git rev-parse --show-toplevel)

source "${EXPERIMENT_DIR_PATH}/scripts/log.sh"
source "${EXPERIMENT_DIR_PATH}/scripts/node.sh"

# Global variables
# -------------------------------------------------------------------------------------------------

INSTANCE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4 || throw_error "Cannot fetch instance IP")
MAIN_NODE_IP="${INSTANCE_IP}"
NUM_NODES=1

# Entrypoint
# -------------------------------------------------------------------------------------------------

function main() {
  parse_args $@
  launch
}

# Steps
# -------------------------------------------------------------------------------------------------

function parse_args {
  for opt in "$@"; do
    case $opt in
      -m=*|--main-node-ip=*)
        MAIN_NODE_IP="${opt#*=}"
        shift ;;
      -n=*|--num-nodes=*)
        NUM_NODES="${opt#*=}"
        shift ;;
      -h|--help)
        help
        exit 0
        ;;
      *)
        echo "unknown option: $opt"
        help
        exit 1
        ;;
    esac
  done
}

function launch {
  log_file_path="${EXPERIMENT_DIR_PATH}/GAN.log"

  launch_node $MAIN_NODE_IP $NUM_NODES &> "${log_file_path}"
}

# Helpers
# -------------------------------------------------------------------------------------------------

function help {
  cat << EOF
Run a Distributed DCGAN experiment
usage: $0 [OPTIONS]
    -h --help            Show this message
    -m --main-node-ip    Defines the main-node IP address
    -n --num-nodes       Defines the number of nodes
EOF
}

# Launch
# -------------------------------------------------------------------------------------------------

main "${@}"
